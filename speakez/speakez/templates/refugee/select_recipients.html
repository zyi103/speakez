{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}
{% load fontawesome %}

{% block content %}
<div class="row text-center bg-secondary">
    <div class="col-sm-12">
        <div class="login-title">
            <h2 class="text-white">refugees</h2>
        </div>
    </div>
</div>
<table id="recipient" class="table table-striped table-bordered display" width="100%">
    <thead>
        <tr>
            <th>Select</th>
            <th>Name</th>
            <th>Contact</th>
            <th>Address</th>
        </tr>
    </thead>
</table>
<button type="button" class="btn btn-primary" onclick="logList()">Next</button>
{% comment %} <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.4/fuse.min.js"></script> {% endcomment %}
<script type="application/javascript">
    let recipient = {{recipient | safe}}
    let recipientList = []
    console.log(recipient)

    $(document).ready(function () {
        let table = $('#recipient').DataTable({
            data: recipient,
            columns: [
                { 
                    aTargets: [0],
                    orderable: false,
                    mRender: function (data, type, row) {
                    return  `<input style="width: 30px; height: 30px;" type="checkbox" id="${row.pk}" name="checkbox" disabled value="checkedValue">`
                    }
                },
                {
                    mRender : function ( data, type, row ) { 
                    return `${row.fields.first_name}, ${row.fields.last_name}`}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return row.fields.phone_number}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return `${row.fields.street_number}<br>${row.fields.street_name}, ${row.fields.city}, ${row.fields.zip_code}`}
                },
            ],
            order: [[ 1, 'asc' ]],
        });
        $('#recipient tbody').on('click', 'tr', function () {
            var recipientData = table.row(this).data()
            var checkbox = document.getElementById(recipientData.pk)
            checkbox.checked = !checkbox.checked
            if (checkbox.checked) {
                recipientList.push(recipientData)
            } else {
                for(var i = recipientList.length - 1; i >= 0; i--) {
                    if(recipientList[i].pk === recipientData.pk) {
                        recipientList.splice(i, 1);
                    }
                }
            }
        }); 

        // Handle form submission event
        $('#frm-example').on('submit', function(e){
            var form = this;

            var rows_selected = table.column(0).checkboxes.selected();

            // Iterate over all selected checkboxes
            $.each(rows_selected, function(index, rowId){
                // Create a hidden element
                $(form).append(
                    $('<input>')
                        .attr('type', 'hidden')
                        .attr('name', 'id[]')
                        .val(rowId)
                );
            });
        });
    })

    function logList() {
        console.log(recipientList)
    }


    {% comment %} const options = {
            shouldSort: true,
            threshold: 0.6,
            location: 0,
            distance: 100,
            maxPatternLength: 32,
            minMatchCharLength: 1,
            keys: [
                "fields.city",
                "fields.demographic_info",
                "fields.emergency_contact",
                "fields.ethnicity",
                "fields.first_name",
                "fields.gender",
                "fields.last_name",
                "fields.martial_status",
                "fields.middle_name",
                "fields.phone_number",
                "fields.street_name",
                "fields.street_number",
                "fields.zip_code",
            ]
        }; {% endcomment %}

{% comment %}     
    $('#searchTextbox').each(function () {
        var elem = $(this);

        // Save current value of element
        elem.data('oldVal', elem.val());

        // Look for changes in the value
        elem.bind("propertychange change click keyup input paste", function (event) {
            // If value has changed...
            if (elem.data('oldVal') != elem.val()) {
                // Updated stored value
                elem.data('oldVal', elem.val());

                // Do action
                var result = fuse.search(elem.val());
                document.getElementById('result').value = JSON.stringify(result)
                console.log(result) 
            }
        });
    }); {% endcomment %}

   
   
    {% comment %} $(document).ready(function () {
        let table = $('#refugees').DataTable({
            data: dataSet,
            columns: [{
                    title: "first_name"
                },
                {
                    title: "middle_name"
                },
                {
                    title: "last_name"
                },
                {
                    title: "gender"
                },
                {
                    title: "age"
                },
            ],
        });
        $('#refugees tbody').on('click', 'td', function () {
            let idx = table.cell(this).index().row;
            var id = table.row(idx).data()[9]
            window.location.href = `/admin/edit_recipients/${id}/`;
        }); {% endcomment %}
  
</script>
{% endblock %}