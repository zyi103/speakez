{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}
{% load fontawesome %}

{% block title %}report{% endblock %}

{% block content %}
<div class="row text-center bg-secondary">
  <div class="col-sm-12">
    <div class="login-title">
      <h2 class="text-white">View Reports</h2>
    </div>
  </div>
</div>
<table id="report" class="table table-striped table-bordered display" width="100%">
    <thead>
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Category</th>
            <th>Message Text</th>
            <th>Recording Preview</th>
            <th>Call Status</th>
            <th>Action</th>
        </tr>
    </thead>
</table>
<script type="application/javascript">
  let calls = {{calls | safe}}
  console.log(calls)

  $(document).ready(function () {
        let table = $('#report').DataTable({
            data: calls,
            columns: [
                {  
                    mRender : function ( data, type, row ) { 
                    return row.date}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return row.time}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return row.category}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return row.content}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return `<audio style="width:100%" controls id="${row.pk}" src='${row.audio}'>`
                    },
                    width: "45%",
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return `<h4 class='strong'>${row.call_status}</h2>`}
                },
                {  
                    mRender : function ( data, type, row ) { 
                    return `<button type="button" class="btn btn-primary" onclick="repeatCall('${row.recipient_id}','${row.message_id}','${row.audio}')">Repeat</button>`}
                },
            ],
            order: [[ 0, 'desc' ]],
        });
  });

  function repeatCall(recipient_id,message_id,audio_url){
      let recipients = [recipient_id]
      let message = {
                pk: message_id,
                audio_url: audio_url
            }
      $.ajax({
            type: "POST",
            url: '/admin/call_recipients/',
            data: {
                'recipients': recipients,
                'message': message,
            },
            success: function(data) {
                console.log("sent")
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
                console.log(thrownError)
            },
        });
  }
</script>
{% endblock %}